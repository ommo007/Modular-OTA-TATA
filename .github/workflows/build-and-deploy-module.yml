name: 'üöÄ Build & Deploy OTA Modules'

on:
  push:
    branches: [ main ]
    paths:
      - 'mock_drivers/**'
  workflow_dispatch:

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

jobs:
  build-and-deploy:
    name: 'Build & Deploy Changed Modules'
    runs-on: ubuntu-latest
    outputs:
      any_modules_deployed: ${{ steps.deploy.outputs.any_modules_deployed }}

    steps:
      - name: 'üõí Checkout Repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'üîç Detect Changed Module Files'
        id: changed_files
        uses: tj-actions/changed-files@v41
        with:
          files: mock_drivers/**

      - name: 'üõ†Ô∏è Setup ESP32 Toolchain'
        if: steps.changed_files.outputs.any_changed == 'true'
        run: |
          echo "Installing ESP32 toolchain dependencies..."
          sudo apt-get update
          sudo apt-get install -y wget flex bison gperf python3 python3-pip python3-venv cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0 jq
          echo "Downloading and installing ESP32 toolchain..."
          cd /tmp
          wget https://dl.espressif.com/dl/xtensa-esp32-elf-gcc8_4_0-esp-2021r2-linux-amd64.tar.gz
          tar -xzf xtensa-esp32-elf-gcc8_4_0-esp-2021r2-linux-amd64.tar.gz
          sudo mv xtensa-esp32-elf /opt/
          echo "/opt/xtensa-esp32-elf/bin" >> $GITHUB_PATH
          echo "Verifying toolchain installation..."
          export PATH="/opt/xtensa-esp32-elf/bin:$PATH"
          xtensa-esp32-elf-gcc --version

      - name: 'üîß Verify Toolchain Setup'
        if: steps.changed_files.outputs.any_changed == 'true'
        run: |
          echo "Final toolchain verification..."
          which xtensa-esp32-elf-gcc || (echo "‚ùå Toolchain not found in PATH" && exit 1)
          echo "‚úÖ Toolchain setup verified"

      - name: 'üîê Validate Environment Variables'
        if: steps.changed_files.outputs.any_changed == 'true'
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_KEY" ]; then
            echo "‚ùå Error: Missing required secrets"
            exit 1
          fi
          echo "‚úÖ Environment variables validated"

      - name: 'üîß Prepare Deployment Script'
        if: steps.changed_files.outputs.any_changed == 'true'
        run: |
          chmod +x ./scripts/deploy-to-supabase.sh

      - name: 'üèóÔ∏è Build & Deploy Changed Modules'
        id: deploy
        if: steps.changed_files.outputs.any_changed == 'true'
        run: |
          echo "Changed files: ${{ steps.changed_files.outputs.all_changed_files }}"
          changed_modules=$(echo "${{ steps.changed_files.outputs.all_changed_files }}" | tr ' ' '\n' | grep -E '^mock_drivers/[^/]+/' | sed 's|mock_drivers/\([^/]*\)/.*|\1|' | sort -u)
          
          if [ -z "$changed_modules" ]; then
            echo "‚úÖ No module directories were changed. Nothing to do."
            # Set output to false so the next job is skipped
            echo "any_modules_deployed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          echo "üì¶ Modules to process:"
          echo "$changed_modules"
          build_or_deploy_failed=false
          
          echo "$changed_modules" | while read module; do
            echo "--- Processing Module: $module ---"
            echo "üî® Building module: $module"
            if ! make -C "mock_drivers/$module" clean || ! make -C "mock_drivers/$module" build; then
              echo "‚ùå Build failed for: $module"
              build_or_deploy_failed=true
              continue
            fi
            echo "‚úÖ Build successful for: $module"

            binary_path="mock_drivers/$module/build/$module.bin"
            echo "üöÄ Deploying module: $module from $binary_path"
            if ! ./scripts/deploy-to-supabase.sh "$module" "$binary_path"; then
              echo "‚ùå Deployment failed for: $module"
              build_or_deploy_failed=true
              continue
            fi
            echo "‚úÖ Deployment successful for: $module"
          done
          
          if [ "$build_or_deploy_failed" = true ]; then
            echo "‚ùå One or more modules failed to build or deploy."
            exit 1
          fi
          
          echo "any_modules_deployed=true" >> "$GITHUB_OUTPUT"
          echo "‚úÖ All changed modules processed successfully."

      - name: 'üìä Report Deployment Summary'
        if: always()
        run: |
          echo "=========================================="
          echo "üéØ DEPLOYMENT SUMMARY"
          echo "=========================================="
          if [ "${{ steps.changed_files.outputs.any_changed }}" != 'true' ]; then
            echo "‚ÑπÔ∏è No module changes were detected in the push."
          elif [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ SUCCESS: All changed modules were built and deployed."
          else
            echo "‚ùå FAILED: The workflow encountered an error."
          fi
          echo "=========================================="

  validate-deployment:
    name: 'Validate Deployment'
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: success() && needs.build-and-deploy.outputs.any_modules_deployed == 'true'

    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      SUPABASE_BUCKET: 'ota-modules'

    steps:
      - name: '‚úÖ Validate Manifest Accessibility'
        run: |
          echo "üîç Checking if manifest is accessible using authenticated endpoint..."
          sleep 5 
          
          MANIFEST_URL="${{ env.SUPABASE_URL }}/storage/v1/object/${{ env.SUPABASE_BUCKET }}/manifest.json"
          echo "Requesting URL: $MANIFEST_URL"

          http_code=$(curl -s --head -w "%{http_code}" \
            -H "Authorization: Bearer ${{ env.SUPABASE_SERVICE_KEY }}" \
            "$MANIFEST_URL" -o /dev/null)

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Manifest is accessible (HTTP 200)."
            echo "üéâ Deployment validation completed successfully."
          else
            echo "‚ùå ERROR: Manifest is not accessible. Received HTTP status: $http_code."
            echo "Please check the Supabase bucket name, permissions, and that the manifest.json was uploaded by the previous job."
            exit 1
          fi